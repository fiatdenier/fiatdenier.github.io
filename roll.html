<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiat Denier - Lucky Roll</title>
    <style>
        /* ... existing styles ... */
    </style>
</head>
<body>
    <script>
        // ... (Audio and Identity logic remains the same) ...

        // # [2026-01-09] Updated: This helper now handles the stats sync properly
        function syncUIWithServer(data) {
            if (data.server_credits !== undefined) {
                rollCredits = data.server_credits;
                localStorage.setItem('rollCredits', rollCredits);
            }
            
            // # FIX: Map 'total_denied' from app.py to the local 'totalSats' variable
            if (data.total_denied !== undefined) {
                totalSats = data.total_denied;
                localStorage.setItem('totalSats', totalSats);
            }
            updateUI();
        }

        async function handleRoll() {
            if (isRolling) return;
            // ... (setup code) ...

            try {
                // ... (fetch code) ...
                const response = await fetch(`${API_BASE}/get-roll?agent_id=${agentId}&sync=${rollCredits}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();

                if (data.error === "LOCKED") { /* ... handle lock ... */ }

                // # [2026-01-09] Use the helper to ensure total_denied is synced immediately
                syncUIWithServer(data);

                // ... (Winning logic remains the same) ...

                // # [2026-01-09] Important: Removed the manual 'totalSats += 10' 
                // Because the server (app.py) is now the source of truth for stats.
            } catch (error) { /* ... error handling ... */ }
        }

        function updateUI() {
            document.getElementById('agent-id-display').innerText = getAgentID();
            document.getElementById('credit-count').innerText = rollCredits;
            // # [2026-01-09] Ensure the UI uses the variable synced from the server
            document.getElementById('total-sats-val').innerText = totalSats.toLocaleString();
        }

        window.onload = async () => {
            updateUI();
            updateJackpotUI();
            
            const agentId = getAgentID();
            try {
                const response = await fetch(`${API_BASE}/get-roll?agent_id=${agentId}&sync=${rollCredits}&admin=true`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();

                if (data.error !== "LOCKED") {
                    syncUIWithServer(data); // # This maps the server's 2555 to the UI
                }
            } catch (e) { 
                console.log("Initial state sync failed."); 
                updateUI();
            }
        };
    </script>
</body>
</html>