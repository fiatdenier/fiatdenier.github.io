<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fiat Denier - Lucky Roll</title>
	<script>
		(function () {
			try {
				// # Check if we are not the top-level window
				if (window.self !== window.top || window.location !== window.parent.location) {
					// # Break out and redirect to the direct URL
					window.top.location.replace(window.self.location.href);
				}
			} catch (e) {
				// # If access to window.top is denied (Cross-Origin error), we are definitely in an iframe
				window.location.replace(window.self.location.href);
			}
		})();
	</script>
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
	<script>if (window.top !== window.self) { window.top.location.replace(window.self.location.href); }</script>
	<style>
		:root {
			--btc-orange: #f7931a;
			--dark-bg: #1a1a1a;
			--win-green: #4CAF50;
			--grey-text: #696969;
			--locked-grey: #444444;
		}

		@keyframes credit-pulse {
			0% {
				transform: scale(1);
			}

			50% {
				transform: scale(1.4);
				color: var(--win-green);
				text-shadow: 0 0 10px var(--win-green);
			}

			100% {
				transform: scale(1);
			}
		}

		.pulse-active {
			animation: credit-pulse 0.6s ease-in-out;
		}

		@keyframes blink {
			50% {
				opacity: 0;
			}
		}

		@keyframes jackpot-glow {
			0% {
				text-shadow: 0 0 5px rgba(76, 175, 80, 0.2);
			}

			50% {
				text-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
			}

			100% {
				text-shadow: 0 0 5px rgba(76, 175, 80, 0.2);
			}
		}

		.glow-active {
			animation: jackpot-glow 3s ease-in-out infinite;
		}

		body {
			font-family: 'Courier New', monospace;
			background: var(--dark-bg);
			color: white;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			margin: 0;
			overflow-x: hidden;
		}

		.card {
			background: #2a2a2a;
			padding: 2rem;
			border-radius: 15px;
			border: 2px solid var(--btc-orange);
			text-align: center;
			box-shadow: 0 0 20px rgba(247, 147, 26, 0.2);
			width: 90%;
			max-width: 400px;
			position: relative;
		}

		.agent-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #333;
		}

		.agent-info {
			text-align: left;
		}

		.agent-id-tag {
			font-size: 0.8rem;
			color: var(--btc-orange);
			font-weight: bold;
			letter-spacing: 1px;
		}

		.agent-status {
			font-size: 0.6rem;
			color: #666;
			text-transform: uppercase;
		}

		.regen-btn {
			cursor: pointer;
			font-size: 0.7rem;
			margin-left: 8px;
			color: var(--grey-text);
			transition: color 0.2s;
			vertical-align: middle;
		}

		.regen-btn:hover {
			color: var(--btc-orange);
		}

		.btc-logo-icon {
			width: 32px;
			height: 32px;
			fill: var(--btc-orange);
			filter: drop-shadow(0 0 5px rgba(247, 147, 26, 0.4));
		}

		#stats-container {
			background: rgba(0, 0, 0, 0.3);
			border: 1px solid #444;
			padding: 10px;
			border-radius: 8px;
			margin-bottom: 15px;
		}

		.stat-label {
			font-size: 0.65rem;
			color: #888;
			letter-spacing: 2px;
			margin-top: 5px;
		}

		.stat-value {
			font-size: 1.5rem;
			font-weight: bold;
		}

		#total-sats-val {
			color: var(--win-green);
			font-size: 1.1rem;
		}

		#slot-container {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin: 1.5rem 0;
			font-size: 5rem;
			font-weight: bold;
			font-family: 'Roboto', sans-serif;
		}

		.slot {
			width: 70px;
			height: 100px;
			line-height: 100px;
			background: #111;
			border-radius: 8px;
			border: 1px solid #333;
			color: var(--btc-orange);
		}

		.rolling {
			animation: blur-spin 0.1s infinite;
			opacity: 0.7;
			filter: blur(2px);
			color: #888;
		}

		@keyframes blur-spin {
			0% {
				transform: translateY(-2px);
			}

			50% {
				transform: translateY(2px);
			}

			100% {
				transform: translateY(0);
			}
		}

		.just-finished {
			color: var(--btc-orange) !important;
			text-shadow: 0 0 15px rgba(247, 147, 26, 0.8);
			transform: scale(1.05);
			transition: all 0.1s ease-out;
		}

		.proof-box {
			background: #111;
			padding: 1rem;
			border-radius: 8px;
			font-size: 0.75rem;
			text-align: left;
			margin-top: 1.5rem;
			word-break: break-all;
			border: 1px dashed #444;
			color: #aaa;
		}

		button {
			background: var(--btc-orange);
			border: none;
			padding: 1rem 2rem;
			font-size: 1.2rem;
			font-weight: bold;
			border-radius: 5px;
			cursor: pointer;
			width: 100%;
			font-family: inherit;
			transition: 0.2s;
			color: white;
		}

		#roll-btn.locked {
			background: var(--locked-grey) !important;
			color: var(--btc-orange) !important;
			cursor: not-allowed;
		}

		#timer {
			font-size: 0.85rem;
			color: var(--grey-text);
			margin-top: 10px;
			height: 20px;
			font-weight: bold;
		}

		.back-link {
			display: block;
			margin-bottom: 20px;
			color: #888;
			text-decoration: none;
			font-size: 0.8rem;
		}

		#ip-lock-msg {
			color: var(--btc-orange);
			font-size: 2.5rem;
			font-weight: bold;
			display: none;
			margin: 1rem 0;
		}

		#leaderboard-overlay,
		#payment-overlay {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: #111;
			border: 2px solid var(--btc-orange);
			padding: 20px;
			z-index: 10001;
			width: 85%;
			max-width: 320px;
			box-shadow: 0 0 30px black;
		}

		#lb-scroll-area {
			max-height: 250px;
			overflow-y: auto;
			margin-bottom: 15px;
			padding-right: 5px;
		}

		.leaderboard-row {
			display: flex;
			justify-content: space-between;
			font-size: 0.8rem;
			padding: 8px 0;
			border-bottom: 1px solid #222;
		}

		.leaderboard-row.me {
			color: var(--btc-orange);
			font-weight: bold;
			border-left: 2px solid var(--btc-orange);
			padding-left: 5px;
		}

		#lb-scroll-area::-webkit-scrollbar {
			width: 4px;
		}

		#lb-scroll-area::-webkit-scrollbar-thumb {
			background: var(--btc-orange);
		}

		#my-rank-box {
			border-top: 1px solid var(--btc-orange);
			margin-top: 10px;
			padding-top: 10px;
			font-size: 0.75rem;
			color: #aaa;
		}

		.buy-credits-btn {
			background: #4CAF50;
			margin-top: 10px;
			padding: 0.8rem;
			font-size: 1rem;
		}

		.buy-credits-btn:hover {
			background: #45a049;
		}

		#qr-container {
			margin: 20px 0;
			display: flex;
			justify-content: center;
		}

		#qr-container canvas {
			border: 3px solid var(--btc-orange);
			border-radius: 10px;
		}

		.payment-amount-selector {
			display: flex;
			gap: 10px;
			margin: 15px 0;
			flex-wrap: wrap;
			justify-content: center;
		}

		.amount-btn {
			flex: 1;
			min-width: 80px;
			padding: 10px;
			background: #333;
			border: 2px solid #555;
			cursor: pointer;
			border-radius: 5px;
			font-size: 0.9rem;
			transition: all 0.2s;
		}

		.amount-btn:hover {
			border-color: var(--btc-orange);
			background: #444;
		}

		.amount-btn.selected {
			background: var(--btc-orange);
			border-color: var(--btc-orange);
			color: white;
		}

		.amount-btn .sats {
			font-weight: bold;
			color: var(--btc-orange);
		}

		.amount-btn.selected .sats {
			color: white;
		}

		.amount-btn .credits {
			font-size: 0.7rem;
			color: #888;
		}

		.amount-btn.selected .credits {
			color: rgba(255, 255, 255, 0.8);
		}

		.payment-status {
			margin-top: 15px;
			padding: 10px;
			background: rgba(76, 175, 80, 0.1);
			border: 1px solid var(--win-green);
			border-radius: 5px;
			color: var(--win-green);
			font-size: 0.85rem;
		}

		.close-btn {
			margin-top: 15px;
			font-size: 0.7rem;
			color: #666;
			cursor: pointer;
			text-align: center;
		}

		.close-btn:hover {
			color: var(--btc-orange);
		}
	</style>
</head>

<body>

	<div class="card">
		<a href="index.html" class="back-link">‚Üê Return to Wire</a>

		<div id="jackpot-container"
			style="background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
			<div style="font-size: 0.6rem; color: #888; letter-spacing: 2px; margin-bottom: 4px;">PROGRESSIVE FREE
				CREDIT JACKPOT</div>
			<div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
				<span id="jackpot-ticker" class="glow-active"
					style="color: var(--win-green); font-size: 1.6rem; font-weight: bold; font-family: 'Courier New', monospace;">210.00</span>
				<span style="font-size: 0.7rem; color: #555;">ROLLS</span>
			</div>
			<div style="font-size: 0.6rem; color: #666; margin-top: 5px; border-top: 1px solid #222; padding-top: 5px;">
				DAILY FREE CREDIT REDEEMED: <span id="daily-count-display">0</span>/100
			</div>
		</div>

		<div class="agent-header">
			<div class="agent-info">
				<div class="agent-status">Sovereign Individual</div>
				<div style="display: flex; align-items: center;">
					<div id="agent-id-display" class="agent-id-tag">...</div>
					<span class="regen-btn" onclick="regenerateIdentity()" title="Regenerate Identity">üîÑ</span>
				</div>
			</div>
			<svg class="btc-logo-icon" viewBox="0 0 64 64">
				<path
					d="M48.2,26.5c1-6.7-4.1-10.3-11.1-12.7l2.3-9.1l-5.5-1.4l-2.2,9c-1.5-0.4-3-0.7-4.4-1.1l2.3-9.1L24,0.8l-2.3,9.1c-1.2-0.3-2.3-0.5-3.5-0.8l0,0l-7.6-1.9l-1.5,5.9c0,0,4.1,0.9,4,1c2.2,0.6,2.6,2,2.6,3.2l-2.6,10.3c0.2,0,0.4,0.1,0.6,0.2c-0.2-0.1-0.4-0.1-0.6-0.2l-3.6,14.5c-0.3,0.7-1,1.7-2.6,1.3c0.1,0.1-4,0.9-4,0.9l-2.7,6.3l7.2,1.8c1.3,0.3,2.6,0.7,3.9,1l-2.3,9.3l5.5,1.4l2.3-9.2c1.5,0.4,3,0.8,4.4,1.1l-2.3,9.2l5.5,1.4l2.3-9.3c9.4,1.8,16.5,1.1,19.5-7.4c2.4-6.9-0.1-10.8-5.1-13.4C46.8,32.3,48.8,29.9,48.2,26.5z M39.6,44.7c-1.7,6.8-13.3,3.1-17.1,2.2l3-12.2C29.3,35.6,41.4,37.6,39.6,44.7z M41.3,26.7c-1.6,6.2-11.2,3.1-14.4,2.3l2.8-11.1C32.9,18.7,43,20.1,41.3,26.7z" />
			</svg>
		</div>

		<div id="stats-container">
			<div class="stat-label">ROLL CREDITS</div>
			<div id="credit-count" class="stat-value">0</div>
			<hr style="border: 0; border-top: 1px solid #333; margin: 8px 0;">
			<div class="stat-label">TOTAL SATS DENIED</div>
			<div id="total-sats-val" class="stat-value">0</div>
		</div>

		<div id="slot-container">
			<div id="slot-0" class="slot">-</div>
			<div id="slot-1" class="slot">-</div>
			<div id="slot-2" class="slot">-</div>
			<div id="slot-3" class="slot">-</div>
		</div>

		<div id="ip-lock-msg">IP LOCKED</div>

		<button id="roll-btn" onclick="handleRoll()">ROLL FOR SATS</button>
		<button class="buy-credits-btn" onclick="showPayment()">‚ö° BUY CREDITS WITH ‚Çø</button>
		<div id="timer"></div>

		<div id="result-area" style="display: none;">
			<div id="status-message" style="margin-top: 15px;"></div>
			<div class="proof-box" id="proof-content">
				<strong>Result:</strong> <span id="res-num"></span><br>
				<strong>Timestamp:</strong> <span id="res-ts"></span><br>
				<strong>Signature:</strong> <span id="res-sig" style="color: #666;"></span>
			</div>
			<button id="copy-btn" onclick="copyProof()" style="display: none; margin-top:10px;">üìã COPY PROOF</button>
		</div>

		<div onclick="showLeaderboard()"
			style="cursor:pointer; font-size:0.6rem; color:#555; margin-top:15px; text-decoration: underline;">
			VIEW GLOBAL LEADERBOARD
		</div>
	</div>

	<div id="leaderboard-overlay">
		<div class="agent-status" style="margin-bottom:15px; color:var(--btc-orange)">TOP SOVEREIGN INDIVIDUALS (TOP 10)
		</div>
		<div id="lb-scroll-area">
			<div id="lb-content">Loading...</div>
		</div>
		<div id="my-rank-box">
			YOUR STATUS: <span id="my-rank-display">CALCULATING...</span>
		</div>
		<div class="close-btn" onclick="document.getElementById('leaderboard-overlay').style.display='none'">[ CLOSE
			TERMINAL ]</div>
	</div>

	<div id="payment-overlay">
		<div class="agent-status" style="margin-bottom:15px; color:var(--btc-orange)">‚ö° LIGHTNING PAYMENT</div>

		<div style="margin-bottom: 15px;">
			<div style="font-size: 0.7rem; color: #888; margin-bottom: 10px;">SELECT AMOUNT:</div>
			<div class="payment-amount-selector">
				<div class="amount-btn selected" onclick="selectAmount(21, 10)">
					<div class="sats">21 sats</div>
					<div class="credits">10 credits</div>
				</div>
				<div class="amount-btn" onclick="selectAmount(42, 20)">
					<div class="sats">42 sats</div>
					<div class="credits">20 credits</div>
				</div>
				<div class="amount-btn" onclick="selectAmount(105, 50)">
					<div class="sats">105 sats</div>
					<div class="credits">50 credits</div>
				</div>
				<div class="amount-btn" onclick="selectAmount(210, 100)">
					<div class="sats">210 sats</div>
					<div class="credits">100 credits</div>
				</div>
			</div>
		</div>

		<button onclick="generateInvoice()" id="generate-invoice-btn" style="margin-bottom: 15px;">GENERATE
			INVOICE</button>

		<div id="invoice-container" style="display: none;">
			<div id="qr-container"></div>

			<div style="margin: 15px 0;">
				<div style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">LIGHTNING INVOICE:</div>
				<div
					style="background: #000; padding: 10px; border-radius: 5px; word-break: break-all; font-size: 0.65rem; color: #666; max-height: 100px; overflow-y: auto;">
					<span id="invoice-text"></span>
				</div>
				<button onclick="copyInvoice()" style="margin-top: 10px; font-size: 0.9rem; padding: 0.5rem;">üìã COPY
					INVOICE</button>
			</div>

			<div class="payment-status" id="payment-status" style="display: none;">
				<div>‚è≥ Waiting for payment...</div>
				<div style="font-size: 0.7rem; margin-top: 5px;">Checking every 3 seconds</div>
			</div>
		</div>

		<div class="close-btn" onclick="closePayment()">[ CLOSE ]</div>
	</div>

	<script>
		const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
		['click', 'touchstart', 'keydown'].forEach(event => {
			window.addEventListener(event, () => {
				if (audioCtx.state === 'suspended') {
					audioCtx.resume();
				}
			}, { once: true });
		});
		const COOLDOWN_MINUTES = 10;
		const API_BASE = "https://api.fiatdenier.com";

		const JACKPOT_FLOOR = 210.0;

		let isRolling = false;
		let rollCredits = parseInt(localStorage.getItem('rollCredits')) || 0;
		let totalSats = parseInt(localStorage.getItem('totalSats')) || 0;

		// Payment state
		let selectedAmount = 21;
		let selectedCredits = 10;
		let currentPaymentHash = null;
		let paymentCheckInterval = null;

		// ==========================================
		// LIGHTNING PAYMENT FUNCTIONS
		// ==========================================

		function showPayment() {
			document.getElementById('payment-overlay').style.display = 'block';
			document.getElementById('invoice-container').style.display = 'none';
			document.getElementById('payment-status').style.display = 'none';
		}

		function closePayment() {
			document.getElementById('payment-overlay').style.display = 'none';
			if (paymentCheckInterval) {
				clearInterval(paymentCheckInterval);
				paymentCheckInterval = null;
			}
		}

		function selectAmount(sats, credits) {
			selectedAmount = sats;
			selectedCredits = credits;

			document.querySelectorAll('.amount-btn').forEach(btn => {
				btn.classList.remove('selected');
			});
			event.target.closest('.amount-btn').classList.add('selected');
		}

		async function generateInvoice() {
			const agentId = getAgentID();
			const btn = document.getElementById('generate-invoice-btn');
			btn.disabled = true;
			btn.innerText = 'GENERATING...';

			try {
				const response = await fetch(`${API_BASE}/create-invoice`, {
					method: 'POST',
					mode: 'cors',
					headers: {
						'Content-Type': 'application/json',
						'X-Requested-With': 'XMLHttpRequest'
					},
					body: JSON.stringify({
						agent_id: agentId,
						amount_sats: selectedAmount
					})
				});

				const data = await response.json();

				if (data.error) {
					alert('Failed to generate invoice: ' + data.error);
					return;
				}

				currentPaymentHash = data.payment_hash;

				const qrContainer = document.getElementById('qr-container');
				qrContainer.innerHTML = '';

				if (typeof QRCode === 'undefined') {
					console.error('QRCode library is missing.');
					qrContainer.innerHTML = '<p style="color:var(--btc-orange); font-size:0.7rem;">QR Library not loaded.</p>';
				} else {
					try {
						new QRCode(qrContainer, {
							text: data.payment_request,
							width: 200,
							height: 200,
							colorDark: "#000000",
							colorLight: "#ffffff",
							correctLevel: QRCode.CorrectLevel.H
						});
					} catch (err) {
						qrContainer.innerHTML = '<p style="color:red; font-size:0.7rem;">QR Execution Failed.</p>';
					}
				}

				document.getElementById('invoice-text').innerText = data.payment_request;
				document.getElementById('invoice-container').style.display = 'block';
				document.getElementById('payment-status').style.display = 'block';

				startPaymentCheck();

			} catch (error) {
				alert('Failed to generate invoice. Please try again.');
			} finally {
				btn.disabled = false;
				btn.innerText = 'GENERATE INVOICE';
			}
		}

		function copyInvoice() {
			const invoiceText = document.getElementById('invoice-text').innerText;
			navigator.clipboard.writeText(invoiceText).then(() => {
				alert('Invoice copied to clipboard!');
			});
		}

		function startPaymentCheck() {
			if (paymentCheckInterval) { clearInterval(paymentCheckInterval); }

			paymentCheckInterval = setInterval(async () => {
				try {
					const response = await fetch(
						`${API_BASE}/check-payment?payment_hash=${currentPaymentHash}`,
						{ headers: { 'X-Requested-With': 'XMLHttpRequest' } }
					);
					const data = await response.json();

					if (data.paid) {
						clearInterval(paymentCheckInterval);
						paymentCheckInterval = null;

						rollCredits = data.roll_credits || rollCredits;
						localStorage.setItem('rollCredits', rollCredits);
						updateUI();

						document.getElementById('payment-status').innerHTML = `
                            <div style="color: var(--win-green);">‚úÖ PAYMENT RECEIVED!</div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">+${data.roll_credits} Roll Credits</div>
                        `;

						confetti({ particleCount: 200, spread: 100, colors: ['#f7931a', '#4CAF50'], zIndex: 99999 });
						playFreeCreditSound();

						await syncStateFromServer();
						setTimeout(() => { closePayment(); }, 3000);
					}
				} catch (error) { console.error('Payment check error:', error); }
			}, 3000);
		}

		// ==========================================
		// PROGRESSIVE & DAILY LIMIT HELPERS
		// ==========================================
		async function updateJackpotUI() {
			const agentId = getAgentID();
			try {
				const response = await fetch(`${API_BASE}/get-global-jackpot?agent_id=${agentId}`, {
					headers: { 'X-Requested-With': 'XMLHttpRequest' }
				});
				const data = await response.json();

				const tickerEl = document.getElementById('jackpot-ticker');
				const countEl = document.getElementById('daily-count-display');

				if (tickerEl && data.current_pot) {
					tickerEl.innerText = parseFloat(data.current_pot).toFixed(2);
				}

				if (countEl && data.daily_count !== undefined) {
					countEl.innerText = data.daily_count;
					if (data.daily_count >= 90) countEl.style.color = "#ff4444";
					else if (data.daily_count >= 70) countEl.style.color = "var(--btc-orange)";
					else countEl.style.color = "white";
				}
			} catch (err) { console.log("Jackpot sync failed."); }
		}

		// --- AUDIO ENGINE ---
		let clickBuffer = null; let dingBuffer = null; let loopSource = null; let freeCreditBuffer = null; let loopGain = null;
		fetch('click.wav').then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(data => { clickBuffer = data; });
		fetch('ding.wav').then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(data => { dingBuffer = data; });
		fetch('free_credit.wav').then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(data => { freeCreditBuffer = data; });

		function playFreeCreditSound() {
			if (!freeCreditBuffer) return;
			const source = audioCtx.createBufferSource();
			source.buffer = freeCreditBuffer;
			source.connect(audioCtx.destination);
			source.start(0);
		}

		function playLoop() {
			if (!clickBuffer) return;
			loopSource = audioCtx.createBufferSource();
			loopSource.buffer = clickBuffer;
			loopSource.loop = true;
			loopGain = audioCtx.createGain();
			loopGain.gain.setValueAtTime(0.25, audioCtx.currentTime);
			loopSource.connect(loopGain);
			loopGain.connect(audioCtx.destination);
			loopSource.start(0);
		}

		function stopLoop() {
			if (loopSource) {
				if (loopGain) loopGain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
				setTimeout(() => { if (loopSource) { loopSource.stop(); loopSource = null; } }, 100);
			}
		}

		function playDing(isJackpot = false) {
			if (!dingBuffer) return;
			const source = audioCtx.createBufferSource();
			source.buffer = dingBuffer;
			if (isJackpot) source.playbackRate.value = 1.3;
			source.connect(audioCtx.destination);
			source.start(0);
		}

		// --- IDENTITY LOGIC ---
		function generateAnimalName() {
			const adjectives = ["Sacred", "Majestic", "Silent", "Golden", "Swift", "Cunning", "Brave", "Ancient", "Hyper", "Stoic", "Ethereal", "Vigilant", "Wild", "Noble", "Fierce", "Lunar", "Solar", "Atomic", "Neon", "Cyber", "Shadow", "Iron", "Glacial", "Volcanic", "Radiant", "Hidden", "Cosmic", "Primal", "Zenith", "Nomad", "Vortex", "Sovereign", "Orphan", "Gilded", "Obsidian"];
			const animals = ["Wolf", "Eagle", "Tiger", "Lion", "Falcon", "Panther", "Raven", "Stag", "Owl", "Bear", "Shark", "Lynx", "Phoenix", "Bison", "Dragon", "Serpent", "Mamba", "Condor", "Jaguar", "Stallion", "Viper", "Kraken", "Gryphon", "Cobra", "Fox", "Rhino", "Mastodon", "Orca", "Mantiss", "Ram", "Scorpion", "Wolverine", "Badger", "Hawk", "Bull"];
			return adjectives[Math.floor(Math.random() * adjectives.length)] + animals[Math.floor(Math.random() * animals.length)];
		}

		function getAgentID() {
			let id = localStorage.getItem('agentID');
			if (!id || id.startsWith('AGENT_')) {
				id = generateAnimalName();
				localStorage.setItem('agentID', id);
			}
			return id;
		}

		function regenerateIdentity() {
			if (!confirm("Regenerate identity?")) return;
			const newId = generateAnimalName();
			localStorage.setItem('agentID', newId);
			document.getElementById('agent-id-display').innerText = newId;
			fetch(`${API_BASE}/update-score`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
				body: JSON.stringify({ agent_id: newId, sats: totalSats })
			});
		}

		async function syncStateFromServer() {
			const agentId = getAgentID();
			try {
				const response = await fetch(`${API_BASE}/get-roll?agent_id=${agentId}&sync=${rollCredits}`, {
					headers: { 'X-Requested-With': 'XMLHttpRequest' }
				});
				const data = await response.json();
				if (data.server_credits !== undefined) {
					rollCredits = data.server_credits;
					localStorage.setItem('rollCredits', rollCredits);
				}
				updateUI();
			} catch (e) { console.log("Sync failed"); }
		}

		async function reconcileStatsFromServer() {
			const agentId = getAgentID();
			try {
				const res = await fetch(`${API_BASE}/leaderboard`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
				const data = await res.json();
				const myEntry = data.find(e => e.agent === agentId);
				totalSats = myEntry ? myEntry.sats : 0;
				localStorage.setItem('totalSats', totalSats);
				updateUI();
			} catch (e) { console.log("Reconciliation failed."); }
		}

		// --- ROLL LOGIC ---
		async function handleRoll() {
			if (isRolling) return;
			const creditsAtStart = rollCredits;
			const btn = document.getElementById('roll-btn');
			const slots = [0, 1, 2, 3].map(i => document.getElementById(`slot-${i}`));

			slots.forEach(slot => { slot.style.color = 'var(--btc-orange)'; });
			isRolling = true; btn.disabled = true; btn.innerText = "ROLLING...";
			document.getElementById('result-area').style.display = 'none';

			const spinIntervals = slots.map(slot => {
				slot.classList.remove('just-finished'); slot.classList.add('rolling');
				return setInterval(() => { slot.innerText = Math.floor(Math.random() * 10); }, 60);
			});

			try {
				if (audioCtx.state === 'suspended') await audioCtx.resume();
				playLoop();
				const agentId = getAgentID();

				// REPAIR: Removed &sync from here so the server generates a REAL roll
				const response = await fetch(`${API_BASE}/get-roll?agent_id=${agentId}`, {
					headers: { 'X-Requested-With': 'XMLHttpRequest' }
				});
				const data = await response.json();

				// REPAIR: Handle forced syncs or empty results safely
				if (data.status === "synced" || !data.num) {
					stopLoop();
					spinIntervals.forEach(clearInterval);
					slots.forEach(s => { s.classList.remove('rolling'); s.innerText = "-"; });
					if (data.server_credits !== undefined) {
						rollCredits = data.server_credits;
						localStorage.setItem('rollCredits', rollCredits);
					}
					isRolling = false; btn.disabled = false; btn.innerText = "ROLL FOR SATS";
					updateUI();
					return;
				}

				if (data.error === "LOCKED") {
					stopLoop(); spinIntervals.forEach(clearInterval);
					showIpLock();
					isRolling = false; btn.disabled = false; btn.innerText = "ROLL FOR SATS"; return;
				}

				rollCredits = data.server_credits;
				localStorage.setItem('rollCredits', rollCredits);
				const stopOrder = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
				const finalStr = data.num.toString().padStart(4, '0');

				for (let i = 0; i < stopOrder.length; i++) {
					const idx = stopOrder[i];
					await new Promise(r => setTimeout(r, 800 + Math.random() * 600));
					clearInterval(spinIntervals[idx]);
					slots[idx].classList.remove('rolling');
					slots[idx].classList.add('just-finished');
					slots[idx].innerText = finalStr[idx];
					playDing(data.num === 2121);
				}
				stopLoop();

				const sig = data.signature;
				const is21Win = finalStr.includes('21');
				const is2121 = (data.num === 2121);
				const isMiracle = sig.startsWith('21') && sig.endsWith('21');

				if (creditsAtStart >= 0) {
					fetch(`${API_BASE}/increment-jackpot?agent_id=${agentId}`, {
						method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }
					}).then(() => updateJackpotUI());
				}

				const statusMsg = document.getElementById('status-message');
				if (isMiracle) {
					fetch(`${API_BASE}/reset-jackpot`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
					rollCredits += 210; totalSats += 2000;
					statusMsg.innerHTML = `<h2 style='color:gold;'>üèõÔ∏è MIRACLE JACKPOT!<br>+2000 SATS</h2>`;
					confetti({ particleCount: 300, spread: 100 });
					playFreeCreditSound();
				} else if (is2121) {
					rollCredits += 21; totalSats += 500;
					statusMsg.innerHTML = "<h3 style='color:var(--btc-orange)'>‚ú® JACKPOT 2121! ‚ú®</h3>";
					confetti({ particleCount: 150 });
					playFreeCreditSound();
				} else if (is21Win) {
					rollCredits += 5; totalSats += 21;
					statusMsg.innerHTML = "<h3 style='color:var(--win-green)'>‚ö° +5 FREE ROLLS ‚ö°</h3>";
					playFreeCreditSound();
					confetti({ particleCount: 50 });
				} else {
					statusMsg.innerHTML = "<h3 style='color:#666'>Better luck next time!</h3>";
				}

				localStorage.setItem('totalSats', totalSats);
				localStorage.setItem('rollCredits', rollCredits);
				document.getElementById('res-num').innerText = data.num;
				document.getElementById('res-ts').innerText = data.ts;
				document.getElementById('res-sig').innerText = data.signature;
				document.getElementById('result-area').style.display = 'block';

				updateUI();

				const scoreResponse = await fetch(`${API_BASE}/update-score`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
					body: JSON.stringify({ agent_id: getAgentID() })
				});
				const scoreData = await scoreResponse.json();
				if (scoreData.new_total !== undefined) {
					totalSats = scoreData.new_total;
					localStorage.setItem('totalSats', totalSats);
					updateUI();
				}

				const dailyCount = parseInt(document.getElementById('daily-count-display').innerText) || 0;
				if (rollCredits <= 0 || dailyCount >= 100) {
					const expiry = Date.now() + (COOLDOWN_MINUTES * 60 * 1000);
					localStorage.setItem('rollCooldown', expiry); startTimer(expiry);
				} else {
					btn.disabled = false; btn.innerText = "ROLL FOR SATS";
				}
				isRolling = false; updateUI();
			} catch (error) {
				// REPAIR: Added button resets here to prevent the freeze on error
				console.error("Roll error:", error);
				stopLoop();
				spinIntervals.forEach(clearInterval);
				isRolling = false;
				btn.disabled = false;
				btn.innerText = "ROLL FOR SATS";
				updateUI();
			}
		}

		function showIpLock() {
			document.getElementById('ip-lock-msg').style.display = 'block';
			document.getElementById('slot-container').style.display = 'none';
		}

		function startTimer(expiry) {
			const timerDiv = document.getElementById('timer');
			const btn = document.getElementById('roll-btn');
			const interval = setInterval(() => {
				const diff = expiry - Date.now();
				const dailyCount = parseInt(document.getElementById('daily-count-display').innerText) || 0;
				if (diff <= 0 || (rollCredits > 0 && dailyCount < 100)) {
					clearInterval(interval); timerDiv.innerText = "";
					btn.disabled = false; btn.classList.remove('locked'); btn.innerText = "ROLL FOR SATS";
					document.getElementById('ip-lock-msg').style.display = 'none';
					document.getElementById('slot-container').style.display = 'flex';
				} else {
					const mins = Math.floor(diff / 60000); const secs = Math.floor((diff % 60000) / 1000);
					timerDiv.innerText = `NEXT ROLL IN: ${mins}:${secs.toString().padStart(2, '0')}`;
					btn.innerText = `LOCKED (${mins}m)`; btn.classList.add('locked'); btn.disabled = true;
				}
			}, 1000);
		}

		function copyProof() {
			const text = document.getElementById('proof-content').innerText;
			navigator.clipboard.writeText(text).then(() => { alert("Proof Copied!"); });
		}

		async function showLeaderboard() {
			document.getElementById('leaderboard-overlay').style.display = 'block';
			const myId = getAgentID();
			try {
				const res = await fetch(`${API_BASE}/leaderboard`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
				const data = await res.json();
				document.getElementById('lb-content').innerHTML = data.slice(0, 10).map((e, i) => `
                    <div class="leaderboard-row ${e.agent === myId ? 'me' : ''}">
                        <span>${i + 1}. ${e.agent}</span>
                        <span>${e.sats.toLocaleString()}</span>
                    </div>
                `).join('');
				const myRank = data.findIndex(e => e.agent === myId) + 1;
				document.getElementById('my-rank-display').innerText = myRank > 0 ? `#${myRank} GLOBAL` : "UNRANKED";
			} catch (e) { document.getElementById('lb-content').innerText = "OFFLINE"; }
		}

		function updateUI() {
			document.getElementById('agent-id-display').innerText = getAgentID();
			document.getElementById('credit-count').innerText = rollCredits;
			document.getElementById('total-sats-val').innerText = totalSats.toLocaleString();
		}

		window.onload = async () => {
			updateUI(); updateJackpotUI();
			await reconcileStatsFromServer();
			setInterval(updateJackpotUI, 10000);

			const agentId = getAgentID();
			const savedExpiry = localStorage.getItem('rollCooldown');
			if (savedExpiry && Date.now() < parseInt(savedExpiry)) {
				const dailyCount = parseInt(document.getElementById('daily-count-display').innerText) || 0;
				if (rollCredits <= 0 || dailyCount >= 100) {
					showIpLock(); startTimer(parseInt(savedExpiry));
				}
			}

			try {
				const response = await fetch(`${API_BASE}/get-roll?agent_id=${agentId}&sync=${rollCredits}&admin=true`, {
					headers: { 'X-Requested-With': 'XMLHttpRequest' }
				});
				const data = await response.json();
				if (data.error === "LOCKED") {
					const expiry = Date.now() + (data.remaining_seconds * 1000);
					localStorage.setItem('rollCooldown', expiry);
					showIpLock(); startTimer(expiry);
				} else if (data.server_credits !== undefined) {
					rollCredits = data.server_credits;
					localStorage.setItem('rollCredits', rollCredits);
					updateUI();
				}
			} catch (e) { console.log("Initial sync failed."); }
		};
	</script>
</body>

</html>