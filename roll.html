import os
import random
import time
import hashlib
import json
from flask import Flask, jsonify, request
from flask_cors import CORS
from dotenv import load_dotenv

load_dotenv(dotenv_path="/home/ubuntu/strategy/.random.env")

app = Flask(__name__)
CORS(app)

SECRET_SALT = os.getenv("MY_GAME_SECRET", "default_salt").strip()
DATA_FILE = "cooldowns.json"
LEADERBOARD_FILE = "leaderboard.json"
COOLDOWN_SECONDS = 600

def load_json(f):
    if os.path.exists(f):
        try:
            with open(f, 'r') as file: return json.load(file)
        except: return {}
    return {}

def save_json(f, data):
    with open(f, 'w') as file: json.dump(data, file)

@app.route('/update-score', methods=['POST'])
def update_score():
    data = request.json
    lb = load_json(LEADERBOARD_FILE)
    agent = data.get('agent_id')
    sats = data.get('sats', 0)
    if agent not in lb or sats > lb[agent]:
        lb[agent] = sats
        save_json(LEADERBOARD_FILE, lb)
    return jsonify({"status": "ok"})

@app.route('/leaderboard', methods=['GET'])
def get_leaderboard():
    lb = load_json(LEADERBOARD_FILE)
    sorted_lb = sorted(lb.items(), key=lambda x: x[1], reverse=True)[:5]
    return jsonify([{"agent": k, "sats": v} for k, v in sorted_lb])

@app.route('/get-roll', methods=['GET'])
def get_roll():
    user_ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0].strip()
    cooldowns = load_json(DATA_FILE)
    now = time.time()
    
    if user_ip in cooldowns and now - cooldowns[user_ip] < COOLDOWN_SECONDS:
        return jsonify({"error": "LOCKED"}), 200

    num = str(random.randint(0, 9999)).zfill(4)
    ts = int(now * 1000)
    signature = hashlib.sha256(f"{num}-{ts}-{SECRET_SALT}".encode()).hexdigest()[:12]
    
    cooldowns[user_ip] = now
    save_json(DATA_FILE, cooldowns)
    
    return jsonify({"num": num, "ts": ts, "signature": signature})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)