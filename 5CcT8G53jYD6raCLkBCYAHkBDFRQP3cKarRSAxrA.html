<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Roll Admin</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; padding: 20px; text-align: center; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin: 0 auto 20px; max-width: 600px; text-align: left; }
        h1 { color: #f2a900; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box { background: #2a2a2a; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-num { display: block; font-size: 24px; font-weight: bold; color: #fff; }
        
        /* # FIXED: Custom List View for Mobile Green Text */
        #user-list-container {
            background: #111;
            border: 1px solid #444;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 5px;
            margin-top: 10px;
        }
        .user-row {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            font-size: 13px;
        }
        .user-row:hover { background: #222; }
        .user-row.selected { background: #333; border-left: 4px solid #f2a900; }
        .user-has-balance { color: #4CAF50 !important; font-weight: bold; }

        .filter-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .toggle-btn { background: #333; color: #888; border: 1px solid #444; padding: 8px; cursor: pointer; border-radius: 4px; flex-grow: 1; font-size: 11px; }
        .toggle-btn.active { background: #4CAF50; color: white; }

        input { width: 100%; padding: 10px; box-sizing: border-box; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; }
        button { background: #f2a900; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .danger { background: #d32f2f; color: white; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="login-box" class="card" style="text-align: center;">
        <h1>üîí Admin Login</h1>
        <input type="password" id="key-input" placeholder="Enter Admin Password">
        <button onclick="saveAndLogin()">Login</button>
    </div>

    <div id="admin-content" style="display:none;">
        <h1>üé∞ Admin Dashboard</h1>
        
        <div class="card" style="border: 2px solid #4CAF50;">
            <div style="font-size: 11px; color: #888;">LIVE PROGRESSIVE JACKPOT</div>
            <div id="admin-jackpot-val" style="font-size: 32px; font-weight: bold; color: #4CAF50;">0.00</div>
        </div>

        <div class="card">
            <div class="stat-grid">
                <div class="stat-box"><span class="stat-num" id="total-players">0</span>Players</div>
                <div class="stat-box"><span class="stat-num" id="active-locks">0</span>Locked IPs</div>
            </div>
        </div>

        <div class="card">
            <h3>üë§ User Management</h3>
            <div class="filter-controls">
                <input type="text" id="user-search" placeholder="Search name..." onkeyup="filterUsers()" style="margin-bottom:0;">
                <button id="balance-filter-btn" class="toggle-btn" onclick="toggleBalanceFilter()">üí∞ BALANCE ONLY</button>
            </div>
            
            <div id="user-list-container">
                <div id="user-list-content">Loading...</div>
            </div>
            <input type="hidden" id="selected-agent-hidden">
        </div>

        <div class="card">
            <h3>üéÅ Quick Actions</h3>
            <input type="number" id="action-amount" placeholder="Amount (Credits or Sats)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="issueCredits()">Grant Credits</button>
                <button onclick="rewriteSats()" style="background:#d32f2f; color:white;">Rewrite Sats</button>
            </div>
            <div id="action-status" style="margin-top:10px; font-size:12px; color:#f2a900;"></div>
        </div>

        <button onclick="loadStats()">üîÑ Refresh Everything</button>
        <button class="danger" onclick="resetLocks()">üíÄ Clear All IP Locks</button>
    </div>

    <script>
        const API_URL = "https://api.fiatdenier.com";
        let allUsers = [];
        let onlyShowBalances = false;
        let selectedAgent = "";

        // # RE-VERIFIED: Login & Auth
        function saveAndLogin() {
            localStorage.setItem('adminKey', document.getElementById('key-input').value);
            checkAuth();
        }

        async function checkAuth() {
            const key = localStorage.getItem('adminKey');
            if (!key) return;
            try {
                const res = await fetch(`${API_URL}/admin-stats?key=${key}`);
                if (res.ok) {
                    document.getElementById('login-box').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    loadStats();
                    setInterval(loadStats, 10000); // Auto-refresh
                }
            } catch (e) { console.error(e); }
        }

        async function loadStats() {
            const key = localStorage.getItem('adminKey');
            try {
                // 1. Fetch Admin Stats (Locks/Counts)
                const resStats = await fetch(`${API_URL}/admin-stats?key=${key}`);
                const dataStats = await resStats.json();
                document.getElementById('total-players').innerText = dataStats.total_unique_players;
                document.getElementById('active-locks').innerText = dataStats.currently_locked_ips;

                // 2. Fetch Jackpot (The missing part)
                const resJackpot = await fetch(`${API_URL}/get-global-jackpot`);
                const dataJackpot = await resJackpot.json();
                document.getElementById('admin-jackpot-val').innerText = parseFloat(dataJackpot.current_pot).toFixed(2);

                // 3. Fetch Players
                const resLB = await fetch(`${API_URL}/leaderboard?admin=true`);
                allUsers = await resLB.json();
                filterUsers();
            } catch (e) { console.log("Refresh failed"); }
        }

        function toggleBalanceFilter() {
            onlyShowBalances = !onlyShowBalances;
            document.getElementById('balance-filter-btn').classList.toggle('active', onlyShowBalances);
            filterUsers();
        }

        function filterUsers() {
            const term = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => {
                const match = u.agent.toLowerCase().includes(term);
                const hasBal = (u.sats > 0 || (u.credits || 0) > 0);
                return onlyShowBalances ? (match && hasBal) : match;
            });
            renderList(filtered);
        }

        function renderList(users) {
            const content = document.getElementById('user-list-content');
            content.innerHTML = users.map(u => {
                const hasBal = (u.sats > 0 || (u.credits || 0) > 0);
                const colorClass = hasBal ? 'user-has-balance' : '';
                const selClass = u.agent === selectedAgent ? 'selected' : '';
                return `<div class="user-row ${colorClass} ${selClass}" onclick="selectUser('${u.agent}')">
                    <span>${u.agent}</span>
                    <span>${u.sats} S / ${u.credits || 0} C</span>
                </div>`;
            }).join('');
        }

        function selectUser(id) {
            selectedAgent = id;
            document.getElementById('selected-agent-hidden').value = id;
            filterUsers();
        }

        // # FIXED: Unified Action handlers
        async function issueCredits() {
            const agent = document.getElementById('selected-agent-hidden').value;
            const amt = document.getElementById('action-amount').value;
            if(!agent) return alert("Select a user first");
            const res = await fetch(`${API_URL}/admin-award?key=${localStorage.getItem('adminKey')}&agent=${agent}&amount=${amt}`);
            const data = await res.json();
            document.getElementById('action-status').innerText = data.status === "Success" ? "‚úÖ Credits Issued" : "‚ùå Failed";
            loadStats();
        }

        async function rewriteSats() {
            const agent = document.getElementById('selected-agent-hidden').value;
            const amt = document.getElementById('action-amount').value;
            if(!agent || !confirm(`Set ${agent} to ${amt} sats?`)) return;
            const res = await fetch(`${API_URL}/admin-rewrite-sats?key=${localStorage.getItem('adminKey')}&agent=${agent}&sats=${amt}`);
            const data = await res.json();
            document.getElementById('action-status').innerText = data.status === "Success" ? "‚úÖ Score Updated" : "‚ùå Failed";
            loadStats();
        }

        async function resetLocks() {
            if(!confirm("Clear all blocks?")) return;
            await fetch(`${API_URL}/admin-reset?key=${localStorage.getItem('adminKey')}`);
            loadStats();
        }

        checkAuth();
    </script>
</body>
</html>
