<!doctype html>
<html lang="en">

<head>
    <script>
        // # ADDED: Frame Buster to prevent page from being embedded in iframes (e.g., Primal)
        if (window.top !== window.self) {
            // Check if we can break out automatically
            try {
                window.top.location.replace(window.self.location.href);
            } catch (e) {
                // If the parent app (Primal) blocks automatic redirection via CSP,
                // we show a full-screen overlay to force the user to open in a real browser.
                window.addEventListener('load', function () {
                    document.body.innerHTML = `
                <div style="background:#1a1a1a; color:white; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-family: 'Roboto', sans-serif; padding:20px;">
                  <h1 style="color:#f7931a;">BITCOIN WIRE</h1>
                  <p>For the best experience, please open this site in your external browser.</p>
                  <a href="${window.location.href}" target="_blank" 
                     style="background:#f7931a; color:white; padding:15px 30px; text-decoration:none; border-radius:5px; font-weight:bold; margin-top:20px;">
                     OPEN IN FULL TAB
                  </a>
                </div>
              `;
                });
            }
        }
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Bitcoin Wire - Last 24 Hours</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fiatdenier.com/">
    <meta property="og:title" content="ðŸŽ° Lucky Roll: Deny Fiat, Win Sats">
    <meta property="og:description"
        content="Test your luck! Roll for a chance to win up to 2000 sats. Fully verified and decentralized.">
    <meta property="og:image" content="https://fiatdenier.com/preview.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* # RESTORED: Dark Theme from roll.html */
        :root {
            --btc-orange: #f7931a;
            --dark-bg: #1a1a1a;
            --win-green: #4CAF50;
            --grey-text: #696969;
        }

        body {
            background: var(--dark-bg);
            color: white;
            margin: 0;
            font-family: 'Roboto', sans-serif;
        }

        /* # UPDATED: Everything Centered */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            width: 100%;
        }

        /* # COMMENTED OUT: Side-alignment logic to maintain center on all screens */
        /*
  @media (min-width: 768px) {
    header {
      flex-direction: row;
      justify-content: space-between;
      text-align: left;
    }
  }
  */

        header h1 a,
        #pagination,
        #page-info {
            font-family: 'Roboto', sans-serif;
            font-weight: 700 !important;
            color: var(--btc-orange) !important;
            text-decoration: none;
        }

        /* # ADDED: Price Ticker Styling */
        #btc-price-ticker {
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            color: var(--win-green);
            font-size: 1.2rem;
            margin: 5px 0;
        }

        #updated {
            font-family: 'Roboto', sans-serif;
            font-weight: 700 !important;
            color: var(--grey-text) !important;
            margin: 0;
        }

        #app a .headline {
            display: block;
            font-family: 'Roboto', sans-serif;
            font-weight: 700 !important;
            color: var(--btc-orange) !important;
            margin-bottom: 4px;
        }

        #app a .meta {
            display: block;
            font-family: 'Roboto', sans-serif;
            font-weight: 700 !important;
            color: #888888 !important;
            font-size: 0.85rem;
        }

        #app a {
            text-decoration: none;
            display: block;
            margin-bottom: 15px;
        }

        .game-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 700 !important;
            transition: background 0.2s;
            background: var(--btc-orange);
            color: white !important;
        }

        /* # UPDATED: Status Bar Theme */
        .game-status-bar {
            font-family: 'Roboto', sans-serif;
            font-size: 0.7rem;
            margin-top: 12px;
            color: #888;
            letter-spacing: 0.5px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .pot-val {
            color: var(--win-green);
            font-weight: bold;
        }

        @keyframes red-glow {
            0% {
                text-shadow: 0 0 5px rgba(255, 68, 68, 0.2);
            }

            50% {
                text-shadow: 0 0 15px rgba(255, 68, 68, 0.8);
            }

            100% {
                text-shadow: 0 0 5px rgba(255, 68, 68, 0.2);
            }
        }

        .exhausted-glow {
            color: #ff4444 !important;
            animation: red-glow 2s ease-in-out infinite;
            font-weight: bold;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
        }

        .modal-content {
            position: relative;
            width: 95%;
            max-width: 1100px;
            height: 90vh;
            margin: 5vh auto;
            background: #2a2a2a;
            border: 2px solid var(--btc-orange);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #111;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-btn {
            background: var(--btc-orange);
            color: #fff !important;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
        }

        #bridge-msg {
            display: none;
            padding: 60px 20px;
            text-align: center;
            color: #ccc;
            flex-grow: 1;
            font-family: 'Roboto', sans-serif;
        }

        #bridge-msg h2 {
            color: var(--btc-orange);
            margin-bottom: 15px;
        }

        #load-status {
            color: #888;
            font-size: 0.8rem;
            margin-left: 10px;
            font-family: 'Roboto', sans-serif;
        }

        iframe {
            flex-grow: 1;
            width: 100%;
            border: none;
            background: white;
            display: block;
        }

        #pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 60px 0;
            width: 100%;
        }

        #pagination button {
            background: #333;
            border: 1px solid #444;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 4px;
            min-width: 120px;
            color: var(--btc-orange) !important;
            font-weight: 700;
        }

        #pagination button:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }
    </style>

    <div id="outbound-bridge"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#1a1a1a; z-index:999999; color:white; font-family: 'Roboto', sans-serif; text-align:center; padding:40px 20px; box-sizing:border-box;">
        <h1 style="color:#f7931a; margin-top:20vh;">BITCOIN WIRE</h1>
        <p style="font-size:18px; line-height:1.6; color:#ccc;">This app's internal browser is restricting the reader
            experience.</p>
        <div style="margin:40px 0;">
            <a id="breakout-link" href="#" target="_blank"
                style="background:#f7931a; color:white; padding:18px 35px; text-decoration:none; border-radius:8px; font-weight:bold; font-size:20px; display:inline-block; box-shadow: 0 4px 15px rgba(247, 147, 26, 0.4);">
                OPEN IN FULL BROWSER
            </a>
        </div>
        <p style="font-size:14px; color:#666;">Tap the button above to view the live news feed.</p>
    </div>

    <script>
        // # ADDED: Detection Logic
        (function () {
            // Check if the page is being viewed in an iframe
            const isIframe = window.self !== window.top;

            if (isIframe) {
                const bridge = document.getElementById('outbound-bridge');
                const link = document.getElementById('breakout-link');
                const currentUrl = window.location.href;

                // Show the bridge overlay
                bridge.style.display = 'block';

                // Modern iOS trick: 'x-safari-https://' forces it out of the app into Safari
                const safariUrl = currentUrl.replace('https://', 'x-safari-https://');
                link.href = safariUrl;

                // Fallback for older iOS versions: just use the standard URL with target="_blank"
                link.onclick = function (e) {
                    // If the special protocol fails, the target="_blank" remains the backup
                    setTimeout(() => {
                        if (!document.hidden) window.location.href = currentUrl;
                    }, 1000);
                };
            }
        })();
    </script>


</head>

<body>
    <header>
        <h1><a href="/">BITCOIN WIRE</a></h1>

        <div id="btc-price-ticker">BTC/USD: Fetching...</div>

        <p id="updated">Checking for updates...</p>

        <button class="game-link" id="lucky-roll-btn" onclick="location.href='roll.html'">ðŸŽ° PLAY LUCKY ROLL</button>

        <div class="game-status-bar">
            PROGRESSIVE FREE CREDIT JACKPOT: <span id="idx-pot" class="pot-val">210.00</span> |
            DAILY FREE CREDIT REDEEMED: <span id="idx-daily">0</span>/100
        </div>
    </header>

    <main id="app" class="grid" style="padding: 20px;"></main>

    <div id="articleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <button class="modal-btn" onclick="postToNostr()">POST TO NOSTR</button>
                    <button class="modal-btn" style="background:#444;" onclick="openExternal()">OPEN EXTERNAL â†—</button>
                    <span id="load-status"></span>
                </div>
                <button class="modal-btn" onclick="closeArticle()" style="background:#555;">CLOSE [X]</button>
            </div>
            <div id="bridge-msg">
                <h2>Direct Access Required</h2>
                <p>This publisher blocks embedded readers to protect their content or advertising.</p>
                <button class="modal-btn" onclick="openExternal()" style="margin-top:20px;">OPEN ARTICLE IN NEW
                    TAB</button>
            </div>
            <iframe id="articleFrame" src=""></iframe>
        </div>
    </div>

    <div id="pagination">
        <button id="prev-btn">Previous</button>
        <span id="page-info"></span>
        <button id="next-btn">Next</button>
    </div>

    <script>
        async function updateBTCPrice() {
            const priceEl = document.getElementById('btc-price-ticker');
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const data = await response.json();
                const price = data.bitcoin.usd;
                priceEl.innerText = `BTC/USD: $${price.toLocaleString()}`;
            } catch (e) {
                console.log("Primary fetch failed, trying fallback...");
                try {
                    const res = await fetch('https://api.coindesk.com/v1/bpi/currentprice.json');
                    const data = await res.json();
                    const altPrice = data.bpi.USD.rate_float;
                    priceEl.innerText = `BTC/USD: $${altPrice.toLocaleString()}`;
                } catch (err) {
                    priceEl.innerText = "BTC/USD: Update Pending...";
                }
            }
        }
        setInterval(updateBTCPrice, 60000);
        updateBTCPrice();
    </script>

    <script type="module">
        import { paginateNews } from './scripts/paginate_news.js';

        document.addEventListener('DOMContentLoaded', () => {
            const version = new Date().getTime();
            paginateNews({
                jsonPath: `./data/news.json?v=${version}&nocache=true`,
                articlesPerSection: 10,
                sections: 3,
                updatedElemId: 'updated',
                appElemId: 'app',
                prevBtnId: 'prev-btn',
                nextBtnId: 'next-btn',
                pageInfoId: 'page-info'
            });
        });

        let currentUrl = '';
        let bridgeTimer;

        window.openArticle = function (url) {
            currentUrl = url.startsWith('http') ? url : 'https://' + url;
            const frameBreakers = ['cointelegraph.com', 'bitcoinmagazine.com', 'btcmanager.com', 'bitcoin.com', 'crypto.news', 'coindesk.com', 'beincrypto.com', 'decrypt.co', 'cryptoslate.com', 'ccn.com', 'theblock.co', 'bloomberg.com', 'wsj.com', 'reuters.com'];
            const isKnownBreaker = frameBreakers.some(domain => currentUrl.toLowerCase().includes(domain));
            const modal = document.getElementById('articleModal');
            const bridge = document.getElementById('bridge-msg');
            const frame = document.getElementById('articleFrame');
            const status = document.getElementById('load-status');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            clearTimeout(bridgeTimer);
            status.innerText = "Connecting...";
            if (isKnownBreaker) { showBridge(); } else {
                bridge.style.display = 'none';
                frame.style.display = 'block';
                frame.src = currentUrl;
                bridgeTimer = setTimeout(() => { showBridge(); }, 4000);
                frame.onload = function () { clearTimeout(bridgeTimer); status.innerText = "Secure Reader Active"; };
            }
        };

        function showBridge() {
            document.getElementById('bridge-msg').style.display = 'block';
            document.getElementById('articleFrame').style.display = 'none';
            document.getElementById('articleFrame').src = '';
            document.getElementById('load-status').innerText = "Compatibility Issue";
        }

        window.closeArticle = function () {
            clearTimeout(bridgeTimer);
            document.getElementById('articleModal').style.display = 'none';
            document.getElementById('articleFrame').src = '';
            document.body.style.overflow = 'auto';
        };

        window.openExternal = () => currentUrl && window.open(currentUrl, '_blank', 'noopener,noreferrer');
        window.postToNostr = () => currentUrl && window.open(`https://nostr.social/post?content=${encodeURIComponent(currentUrl)}`, '_blank');

        document.getElementById('app').addEventListener('click', e => {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.includes('roll.html')) {
                e.preventDefault();
                window.openArticle(link.href);
            }
        });
    </script>

    <script>
        // # ADDED: Bot Shield Headers Constant
        const SECURE_HEADERS = { 'X-Requested-With': 'XMLHttpRequest' };

        async function syncRoll() {
            const btn = document.getElementById('lucky-roll-btn');
            const countEl = document.getElementById('idx-daily');
            const agentId = localStorage.getItem('agentID') || "UnknownAgent";
            let expiry = localStorage.getItem('rollCooldown');
            let rollCredits = parseInt(localStorage.getItem('rollCredits')) || 0;

            // # UI FALLBACK (Local Storage)
            let potVal = parseFloat(localStorage.getItem('fiat_miracle_pot')) || 210.00;
            const todayStr = new Date().toDateString();
            let displayCount = 0;

            // # SERVER SYNC FOR JACKPOT & DAILY USAGE
            try {
                const jRes = await fetch(`https://api.fiatdenier.com/get-global-jackpot?agent_id=${agentId}`, {
                    headers: SECURE_HEADERS
                });
                const jData = await jRes.json();
                if (jData.current_pot) {
                    potVal = jData.current_pot;
                    localStorage.setItem('fiat_miracle_pot', potVal);
                }
                if (jData.daily_count !== undefined) {
                    displayCount = jData.daily_count;
                    localStorage.setItem('dailyUsage', JSON.stringify({ date: todayStr, count: displayCount }));
                }
            } catch (e) { console.log("Header jackpot sync failed."); }

            // # UI UPDATE
            countEl.innerText = displayCount;
            document.getElementById('idx-pot').innerText = potVal.toFixed(2);

            if (displayCount >= 100) {
                countEl.classList.add('exhausted-glow');
            } else {
                countEl.classList.remove('exhausted-glow');
            }

            try {
                const response = await fetch(`https://api.fiatdenier.com/get-roll?agent_id=${agentId}&sync=${rollCredits}&admin=true`, {
                    headers: SECURE_HEADERS
                });
                const data = await response.json();

                if (data.server_credits !== undefined) {
                    rollCredits = data.server_credits;
                    localStorage.setItem('rollCredits', rollCredits);
                }
                if (data.error === "LOCKED" && data.remaining_seconds) {
                    expiry = Date.now() + (data.remaining_seconds * 1000);
                    localStorage.setItem('rollCooldown', expiry);
                }
            } catch (e) {
                console.log("Index sync poll failed.");
            }

            const now = Date.now();

            if (expiry && now < parseInt(expiry)) {
                const diff = parseInt(expiry) - now;
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);

                btn.style.backgroundColor = "#ADADAD";
                btn.style.color = "#DBDBDB";
                btn.style.pointerEvents = "none";
                btn.innerText = `ðŸŽ° LOCKED (${mins}:${secs.toString().padStart(2, '0')})`;
                setTimeout(syncRoll, 1000);
            } else {
                btn.style.backgroundColor = "var(--btc-orange)";
                btn.style.color = "#fff";
                btn.style.pointerEvents = "auto";
                btn.innerText = "ðŸŽ° PLAY LUCKY ROLL";
            }
        }

        window.addEventListener('load', syncRoll);
        window.addEventListener('focus', syncRoll);
    </script>

</body>

</html>