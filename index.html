<div id="articleModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <button class="modal-btn" onclick="postToNostr()">POST TO NOSTR</button>
                <button class="modal-btn" style="background:#444;" onclick="openExternal()">OPEN IN NEW TAB â†—</button>
            </div>
            <span id="load-status" style="color: #888; font-size: 0.8rem; margin-left: 10px;">Checking security...</span>
            <button class="modal-btn" onclick="closeArticle()" style="background:#cc0000;">CLOSE [X]</button>
        </div>
        <iframe id="articleFrame" src="" style="width:100%; height:calc(100% - 60px); border:none; background:white;"></iframe>
    </div>
</div>

<script type="module">
import { paginateNews } from './scripts/paginate_news.js';

paginateNews({
  jsonPath: './data/news.json',
  articlesPerSection: 10,
  sections: 3,
  updatedElemId: 'updated',
  appElemId: 'app',
  prevBtnId: 'prev-btn',
  nextBtnId: 'next-btn',
  pageInfoId: 'page-info'
});

let loadTimer;

window.openArticle = function(url) {
    const frame = document.getElementById('articleFrame');
    const status = document.getElementById('load-status');
    const modal = document.getElementById('articleModal');

    // 1. Reset state
    clearTimeout(loadTimer);
    status.innerText = "Checking compatibility...";
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    frame.src = url;

    // 2. The "Elegant Check": 2.5-second timeout
    loadTimer = setTimeout(() => {
        // If the frame hasn't signaled it's 'loaded' yet, it's likely a frame-breaker
        console.log("Compatibility check failed. Switching to tab mode.");
        closeArticle(); // Close modal
        window.open(url, '_blank', 'noopener,noreferrer'); // Open in tab
    }, 2500);

    // 3. If it loads successfully before the timeout
    frame.onload = function() {
        clearTimeout(loadTimer);
        status.innerText = "Secure Reader Active";
        console.log("Compatibility confirmed.");
    };
};

window.closeArticle = function() {
    clearTimeout(loadTimer);
    document.getElementById('articleModal').style.display = 'none';
    document.getElementById('articleFrame').src = '';
    document.body.style.overflow = 'auto';
};

window.openExternal = function() {
    const url = document.getElementById('articleFrame').src;
    if(url) window.open(url, '_blank', 'noopener,noreferrer');
};

window.postToNostr = function() {
    const url = document.getElementById('articleFrame').src;
    if(url) window.open(`https://nostr.social/post?content=${encodeURIComponent("Read this on Fiat Denier: " + url)}`, '_blank');
};

document.getElementById('app').addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && link.href && !link.href.includes('roll.html') && !link.href.includes('github.com')) {
        e.preventDefault();
        window.openArticle(link.href);
    }
});
</script>